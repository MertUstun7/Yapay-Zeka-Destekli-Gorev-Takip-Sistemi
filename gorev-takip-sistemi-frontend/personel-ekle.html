<!DOCTYPE html>
<html lang="tr">
<head>
    <!-- Karakter seti ve responsive ayarlar -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personel Ekle - Görev Takip Sistemi</title>
    <!-- Bootstrap ve FontAwesome kütüphaneleri -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Renk değişkenleri ve genel stiller */
        :root {
            --primary-color: #4a90e2;
            --secondary-color: #f5f6fa;
            --text-color: #2c3e50;
            --success-color: #2ecc71;
            --error-color: #e74c3c;
        }

        /* Sayfa gövdesi stili */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--secondary-color);
            color: var(--text-color);
            min-height: 100vh;
        }

        /* Navbar stili */
        .navbar {
            background-color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Form kutusu stili */
        .form-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 2rem;
            margin-top: 2rem;
        }

        /* Form başlığı stili */
        .form-title {
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            font-weight: 600;
        }

        /* Etiket stili */
        .form-label {
            font-weight: 500;
            color: var(--text-color);
            margin-bottom: 0.5rem;
        }

        /* Giriş kutusu stili */
        .form-control {
            border-radius: 8px;
            border: 1px solid #e1e1e1;
            padding: 0.75rem;
            transition: all 0.3s ease;
        }

        /* Giriş kutusu odaklanınca */
        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(74, 144, 226, 0.25);
        }

        /* Seçim kutusu stili */
        .form-select {
            border-radius: 8px;
            border: 1px solid #e1e1e1;
            padding: 0.75rem;
            transition: all 0.3s ease;
        }

        /* Seçim kutusu odaklanınca */
        .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(74, 144, 226, 0.25);
        }

        /* Gönder butonu stili */
        .btn-submit {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        /* Gönder butonu üzerine gelince */
        .btn-submit:hover {
            background-color: #357abd;
            transform: translateY(-2px);
        }

        /* Form grup aralığı */
        .form-group {
            margin-bottom: 1.5rem;
        }

        /* Zorunlu alan işareti */
        .required-field::after {
            content: "*";
            color: var(--error-color);
            margin-left: 4px;
        }

        /* Uyarı kutusu stili */
        .alert {
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        /* Departman seçim kutusu stili */
        .department-select {
            width: 100%;
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid #e1e1e1;
            transition: all 0.3s ease;
        }

        /* Departman seçim kutusu odaklanınca */
        .department-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(74, 144, 226, 0.25);
        }
    </style>
</head>
<body>
    <!-- Navbar (Üstteki navigasyon barı) -->
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-tasks me-2"></i>
                Görev Takip Sistemi
            </a>
            <div class="d-flex align-items-center">
                <!-- Geri butonu -->
                <button class="btn btn-outline-primary" onclick="goBack()">
                    <i class="fas fa-arrow-left me-2"></i>Geri
                </button>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="form-container">
                    <!-- Personel ekleme formu başlığı -->
                    <h2 class="form-title text-center mb-4">
                        <i class="fas fa-user-plus me-2"></i>Yeni Personel Ekle
                    </h2>
                    
                    <!-- Uyarı mesajlarının gösterileceği alan -->
                    <div id="alertContainer"></div>

                    <!-- Personel ekleme formu başlangıcı -->
                    <form id="personnelForm" onsubmit="handleSubmit(event)">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <!-- Ad alanı -->
                                    <label class="form-label required-field" for="firstName">Ad</label>
                                    <input type="text" class="form-control" id="firstName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <!-- Soyad alanı -->
                                    <label class="form-label required-field" for="lastName">Soyad</label>
                                    <input type="text" class="form-control" id="lastName" required>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <!-- E-posta alanı -->
                                    <label class="form-label required-field" for="email">E-posta</label>
                                    <input type="email" class="form-control" id="email" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <!-- Telefon alanı -->
                                    <label class="form-label required-field" for="phoneNumber">Telefon</label>
                                    <input type="tel" class="form-control" id="phoneNumber" required>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <!-- Şifre alanı -->
                                    <label class="form-label required-field" for="password">Şifre</label>
                                    <input type="password" class="form-control" id="password" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <!-- Departman alanı -->
                                    <label class="form-label required-field" for="department">Departman</label>
                                    <input type="text" class="form-control" id="department" required>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <!-- Rol seçimi -->
                                    <label class="form-label required-field" for="role">Rol</label>
                                    <select class="form-select" id="role" required>
                                        <option value="">Rol Seçin</option>
                                        <option value="worker">Çalışan</option>
                                        <option value="manager">Yönetici</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <!-- Açıklama alanı -->
                            <label class="form-label" for="userDescription">Açıklama</label>
                            <textarea class="form-control" id="userDescription" rows="3"></textarea>
                        </div>

                        <div class="text-center mt-4">
                            <!-- Formu gönder butonu -->
                            <button type="submit" class="btn btn-submit">
                                <i class="fas fa-save me-2"></i>Personel Ekle
                            </button>
                        </div>
                    </form>
                    <!-- Personel ekleme formu bitişi -->
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Token kontrolü ve yetkilendirme işlemleri
        const token = localStorage.getItem('accessToken');
        if (!token) {
            // Eğer token yoksa giriş sayfasına yönlendir
            window.location.href = 'home.html';
        } else {
            try {
                // Token'ı çözümle ve rol kontrolü yap
                const payloadBase64 = token.split('.')[1];
                const decodedPayload = atob(payloadBase64);
                const payload = JSON.parse(decodedPayload);
                
                const role = payload["http://schemas.microsoft.com/ws/2008/06/identity/claims/role"];
                if (role !== "CompanyOwner") {
                    // Eğer kullanıcı CompanyOwner değilse yetkisiz sayfasına yönlendir
                    window.location.href = 'unauthorized.html';
                }
            } catch (error) {
                // Token çözümlenemediğinde giriş sayfasına yönlendir
                console.error("Token çözümlenemedi:", error);
                localStorage.removeItem('accessToken');
                window.location.href = 'home.html';
            }
        }

        // Uyarı mesajı gösteren fonksiyon
        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            alertContainer.appendChild(alert);
        }

        // Form gönderildiğinde çalışan fonksiyon
        async function handleSubmit(event) {
    event.preventDefault();

    // Şifreyi al
    const password = document.getElementById('password').value;

    // Şifre güvenlik kontrolü (en az 8 karakter, büyük harf, küçük harf, sayı ve özel karakter)
    const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[\W_]).{5,}$/;
    if (!passwordRegex.test(password)) {
        showAlert(
            'Şifre en az 8 karakter olmalı ve en az bir büyük harf, bir küçük harf, bir sayı ve bir özel karakter içermelidir.',
            'danger'
        );
        return;
    }

    // Form verilerini topla
    const formData = {
        firstName: document.getElementById('firstName').value,
        lastName: document.getElementById('lastName').value,
        email: document.getElementById('email').value,
        password: password,
        phoneNumber: document.getElementById('phoneNumber').value,
        department: document.getElementById('department').value,
        role: document.getElementById('role').value,
        userDescription: document.getElementById('userDescription').value
    };

    try {
        // API'ye personel ekleme isteği gönder
        const response = await fetch('https://localhost:7201/api/user', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(formData)
        });

        if (response.ok) {
            // Başarılıysa uyarı göster ve formu sıfırla
            showAlert('Personel başarıyla eklendi!', 'success');
            document.getElementById('personnelForm').reset();
        } else {
            // Hata mesajını göster
            const error = await response.json();
            showAlert(error.message || 'Personel eklenirken bir hata oluştu.', 'danger');
        }
    } catch (error) {
        // İstek sırasında hata oluşursa uyarı göster
        console.error('Error:', error);
        showAlert('Bir hata oluştu. Lütfen tekrar deneyin.', 'danger');
    }
}
        // Geri butonu fonksiyonu
        function goBack() {
            window.history.back();
        }
    </script>
</body>
</html> 