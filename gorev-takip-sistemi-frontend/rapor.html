<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rapor Oluştur - Görev Takip Sistemi</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Arka plan ve animasyon ayarları */
        body {
            background: linear-gradient(135deg, #6b7280, #a5b4fc, #60a5fa);
            background-size: 200% 200%;
            animation: gradientShift 15s ease infinite;
            min-height: 100vh;
        }
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        /* Cam efekti için stil */
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        /* Dosya yükleme butonu stili */
        .file-upload {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        .file-upload:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .file-upload input[type="file"] {
            position: absolute;
            top: 0;
            right: 0;
            min-width: 100%;
            min-height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        /* Özel scrollbar stili */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="min-h-screen py-8">
    <div class="container mx-auto px-4">
        <!-- Üst başlık ve geri dön butonu -->
        <header class="mb-8">
            <div class="flex justify-between items-center">
                <h1 class="text-3xl font-bold text-white">Rapor Oluştur</h1>
                <button onclick="window.history.back()" class="px-4 py-2 bg-white/10 hover:bg-white/20 text-white rounded-lg transition duration-300 flex items-center gap-2">
                    <i class="fas fa-arrow-left"></i>
                    Geri Dön
                </button>
            </div>
        </header>

        <!-- Ana form kutusu (cam efektiyle) -->
        <div class="glass-effect rounded-2xl p-8 max-w-4xl mx-auto">
            <form id="reportForm" class="space-y-6">
                <!-- Görev seçimi -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Görev Seçin</label>
                    <select id="taskSelect" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                        <option value="">Görev seçin...</option>
                    </select>
                </div>

                <!-- Rapor içeriği alanı -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Rapor İçeriği</label>
                    <textarea id="content" rows="6" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 custom-scrollbar" placeholder="Rapor içeriğini buraya yazın..." required></textarea>
                </div>

                <!-- Görev durumu seçimi -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Görev Durumu</label>
                    <select id="status" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                        <option value="">Durum seçin...</option>
                        <option value="started">Başlandı</option>
                        <option value="in_progress">Devam Ediyor</option>
                        <option value="completed">Tamamlandı</option>
                        <option value="pending">Beklemede</option>
                        <option value="cancelled">İptal Edildi</option>
                    </select>
                </div>

                <!-- PDF dosyası yükleme alanı -->
                <div class="file-upload">
                    <label class="block text-sm font-medium text-gray-700 mb-2">PDF Dosyası (Opsiyonel)</label>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-500 transition-colors">
                        <i class="fas fa-file-pdf text-4xl text-red-500 mb-3"></i>
                        <p class="text-gray-600 mb-2">PDF dosyasını buraya sürükleyin veya seçin</p>
                        <p class="text-sm text-gray-500">Maksimum dosya boyutu: 5MB</p>
                        <input type="file" id="pdfFile" accept=".pdf" class="mt-2">
                    </div>
                </div>

                <!-- Gönder butonu -->
                <div class="flex justify-end">
                    <button type="submit" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-300 flex items-center gap-2">
                        <i class="fas fa-paper-plane"></i>
                        Raporu Gönder
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Kullanıcı token kontrolü, yoksa ana sayfaya yönlendir
        const token = localStorage.getItem('accessToken');
        if (!token) window.location.href = 'home.html';

        // Görevleri yükleyen fonksiyon
        async function loadTasks() {
            try {
                const response = await fetch('https://localhost:7201/api/task/user-assigned', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) throw new Error('Görevler yüklenemedi');

                const tasks = await response.json();
                const taskSelect = document.getElementById('taskSelect');

                // URL'den taskId'yi al
                const urlParams = new URLSearchParams(window.location.search);
                const taskId = urlParams.get('taskId');

                // Görevleri select kutusuna ekle ve URL'den gelen taskId'yi seçili yap
                tasks.forEach(task => {
                    const option = document.createElement('option');
                    option.value = task.id;
                    option.textContent = `${task.title} (${task.status})`;
                    taskSelect.appendChild(option);

                    // Eğer URL'den gelen taskId varsa ve bu görev varsa, seçili hale getir
                    if (taskId && task.id === taskId) {
                        option.selected = true;
                    }
                });
            } catch (error) {
                console.error('Görevler yüklenirken hata:', error);
                alert('Görevler yüklenirken bir hata oluştu');
            }
        }

        // Form gönderimi işlemleri
        document.getElementById('reportForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            // Form verilerini topla
            const formData = new FormData();
            formData.append('TaskItemId', document.getElementById('taskSelect').value);
            formData.append('Content', document.getElementById('content').value);
            formData.append('StatusAtReportTime', document.getElementById('status').value);

            // PDF dosyası ekle (varsa ve boyutu uygunsa)
            const pdfFile = document.getElementById('pdfFile').files[0];
            if (pdfFile) {
                if (pdfFile.size > 5 * 1024 * 1024) { // 5MB kontrol
                    alert('Dosya boyutu 5MB\'dan büyük olamaz');
                    return;
                }
                formData.append('PdfFile', pdfFile);
            }

            try {
                // API'ye rapor gönder
                const response = await fetch('https://localhost:7201/api/reports', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Rapor oluşturulamadı');
                }

                alert('Rapor başarıyla oluşturuldu');
                window.history.back();
            } catch (error) {
                console.error('Rapor oluşturulurken hata:', error);
                alert('Rapor oluşturulurken bir hata oluştu: ' + error.message);
            }
        });

        // Sayfa yüklendiğinde görevleri yükle
        document.addEventListener('DOMContentLoaded', loadTasks);

        // Dosya sürükle-bırak işlevselliği için event'ler
        const dropZone = document.querySelector('.file-upload');
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });

        // Varsayılan olayları engelleyen fonksiyon
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        // Sürükleme sırasında vurgulama
        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, highlight, false);
        });

        // Sürükleme bırakıldığında vurgulamayı kaldır
        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, unhighlight, false);
        });

        function highlight(e) {
            dropZone.classList.add('border-blue-500');
        }

        function unhighlight(e) {
            dropZone.classList.remove('border-blue-500');
        }

        // Dosya bırakıldığında input'a dosyayı ekle
        dropZone.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            document.getElementById('pdfFile').files = files;
        }
    </script>
</body>
</html> 